<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta name=author content="longfei"><meta name=description content="我的个人博客"><meta name=keywords content="Golang,Database,macOS,Life,Thinking"><link rel=prev href=https://longfeis.me/2021/my-2020/><link rel=next href=https://longfeis.me/2021/disney/><link rel=canonical href=https://longfeis.me/2021/realize-rownum/><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>基于MySQL的rownum伪列功能 | Longfei's Blog</title><meta name=title content="基于MySQL的rownum伪列功能 | Longfei's Blog"><link rel=stylesheet href=/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/longfeis.me\/"},"articleSection":"posts","name":"基于MySQL的rownum伪列功能","headline":"基于MySQL的rownum伪列功能","description":"rownum伪列功能 伪列的含义就是说：实际上该列并不存在，但是你可以直接像正常的列一样使用它。rownum伪列是Oracle用来标记返回数据","inLanguage":"zh-cn","author":"longfei","creator":"longfei","publisher":"longfei","accountablePerson":"longfei","copyrightHolder":"longfei","copyrightYear":"2021","datePublished":"2021-03-16 23:21:17 \u002b0800 \u002b0800","dateModified":"2021-03-16 23:21:17 \u002b0800 \u002b0800","url":"https:\/\/longfeis.me\/2021\/realize-rownum\/","wordCount":"2730","keywords":["Databasee","Longfei\u0027s Blog"]}</script></head><body><div class=wrapper><nav class=navbar><progress class=content_progress max=0 value=0></progress><div class=container><div class="navbar-header header-back2home-logo"><span class=logo_mark>➜ ~</span>
<a href=https://longfeis.me/><span class=logo_text>sudo rm -fr /</span>
<span class=logo_cursor></span></a></div><div class=navbar-right><span class=menu><a class=menu-item href=/posts/ title>Blog</a>
<a class=menu-item href=/wiki/ title>Wiki</a>
<a class=menu-item href=/categories/ title>Categories</a>
<a class=menu-item href=/tags/ title>Tags</a>
<a class=menu-item href=/about/ title>About</a>
<span class=divide></span><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></span></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><progress class=content_progress max=0 value=0></progress><div class=container><div class=navbar><div class="navbar-header header-logo"><a href=https://longfeis.me/>Longfei's Blog</a></div><div class=navbar-right><div><a href=javascript:void(0); class=theme-switch><i class="iconfont icon-dark-mode"></i></a></div><div class=menu-toggle><span></span><span></span><span></span></div></div></div><div class=menu id=mobile-menu><nav class=mb-md><a class=menu-item href=/posts/ title><h3>Blog</h3><div class=menu-active></div></a><a class=menu-item href=/wiki/ title><h3>Wiki</h3><div class=menu-active></div></a><a class=menu-item href=/categories/ title><h3>Categories</h3><div class=menu-active></div></a><a class=menu-item href=/tags/ title><h3>Tags</h3><div class=menu-active></div></a><a class=menu-item href=/about/ title><h3>About</h3><div class=menu-active></div></a></nav></div></div></nav><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">基于MySQL的rownum伪列功能</h1><div class=post-meta>Written by <a itemprop=name href=https://longfeis.me/ rel=author>longfei</a> with ♥
<span class=post-time>on <time datetime=2021-03-16 itemprop=datePublished>March 16, 2021</time></span>
in
<i class="iconfont icon-folder"></i>
<span class=post-category><a href=https://longfeis.me/categories/coding-1024/>coding 1024,</a></span>
<span class=post-word-count>2730 words</span></div></header><div class=post-content><br><h2 id=rownum伪列功能>rownum伪列功能</h2><p>伪列的含义就是说：实际上该列并不存在，但是你可以直接像正常的列一样使用它。rownum伪列是Oracle用来标记返回数据行号的。Oracle中没有limit，通过在where条件中使用rownum伪列，可以达到跟MySQL中limit类似的效果。</p><p>使用时需要注意以下几点：</p><ol><li>rownum的生成时机。跟rownum窗口函数类似，是在最后的order by之前生成。</li><li>where条件中的“rownum>正整数”将会导致select结果为空</li></ol><p>rownum最常见的应用是topN，即前几名的场景，但是要区分以下两种sql，其效果是完全不一样的。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#75715e>-- 对t表的前N行数据按成绩排序
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> rownum, t.<span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t <span style=color:#66d9ef>where</span> rownum <span style=color:#f92672>&lt;</span> N <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> grade;
<span style=color:#75715e>-- 取前N名
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> rownum, T.<span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> (<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> grade) T <span style=color:#66d9ef>where</span> rownum <span style=color:#f92672>&lt;</span> N;
</code></pre></div><h2 id=架构与设计>架构与设计</h2><h3 id=架构>架构</h3><p><img src=https://cdn.jsdelivr.net/gh/longf2021/myImage@main/mysql_base/basic_framework.jpg alt=basic_framework loading=lazy></p><p>如上图所示，这是我画的一个架构图，很简单的一个基于MySQL的分布式数据库的实现方案（maybe中间件？）。其中，gate是整个系统的入口，负责根据meta data，将sql转发到底下的MySQL上。</p><p>我们的任务就是在这个架构上实现类似Oracle中的rownum伪列的功能。</p><h3 id=设计>设计</h3><p>总体思想：取到数据之后，在order by之前，为每行加上行号，并根据where条件中的rownum表达式，完成数据的过滤。</p><ol><li><p>需要拉取的数据太多，但实际上只需要输出少量数据</p><ul><li><p>使用流模式去拉取数据</p><p><em>暂未实现</em></p></li><li><p>将rownum改写成一个limit</p><p>将rownum转换为limit，下推到每个MySQL上，汇聚数据以后，再在gate上对数据进行添加行号的操作。比如，<code>select rownum,t.* from t where rownum&lt;10;</code> 改写为 <code>select t.* from t limit 10</code> 下推;</p><p>具体而言，就是将rownum&lt;=x order by xxx转换为(limit x) order by xxx，这样就是在每个mysql上先进行limit，然后对limit的结果进行排序。每个mysql的结果汇集到gate上后，再执行一遍limit，再进行order by排序。</p><p>将rownum转换为limit可以分为以下这些场景：</p><ul><li>rownum=x时，当x>1时不返回数据；当x=1返回第一行，可以转换为limit 1。</li><li>rownum!=x 时，当x&lt;1返回全部数据，当x>=1等价与rownum&lt;x，可以转换为limit x-1。</li><li>rownum &lt;= x 时，当x&lt;=0时转为limit 0，返回空集；x>0时转换为limit x，返回前x行)</li><li>rownum &lt; x时，当x&lt;=1转换为limit 0，返回空集；x>1时转换为limit x-1，返回前x-1行)</li><li>rownum>x时，当x&lt;1，返回全部数据， x>=1返回空集</li><li>rownum>=x时，当x&lt;=1，返回全部数据，x>1返回空集</li></ul><p>以rownum=1为例：</p><ul><li>在没有order by的情况，oracle的文档描述是说结果是不确定的。我们转换为limit 1，是会下推的每个mysql上的，在每个mysql上取一行数据到gate上，然后在返回最先到达gate的那行数据，因此，我们的行为也是不确定的。</li><li>在加了order by的情况下，Oracle的rownum是在order by之前进行，所以就有了where rownum&lt;x order by xxx和 (order by xxx) where rownum&lt;x 的区别，括号强行让rownum在order by之后进行。对于前者，直接转换为limit，就改变了语义（变成了先排序，在加rownum），所以需要将提升order by子句；对于后者，直接转化为limit即可。</li><li>因为索引的关系，rownum&lt;=x order by xxx在oracle中的结果是不确定的。我们转换为(limit x) order by xxx后，要做两遍limit，一遍在每个mysql上，另外一遍在gate上，结果也是不确定的，但不确定的原理是不一样的。</li></ul></li></ul></li><li><p>对于不分shard的表来说，性能可以再优化</p><p>可以直接对rownum进行改写，将改写的SQL发往底下的MySQL上。这样的好处是省去了gate对取回来的数据再次做加序号排序的工作。具体的改写方法可以参考附录一。</p></li><li><p>复杂条件的处理</p><ul><li><p>in/not in表达式</p><p>主要对in的内容有要求：排除小于1的数，最小值不为1则输出空集，最小值为1时，则输出到连续的最大值；</p><p>对于not in：小于1的不起任何作用，列表中包含1则输出空集；不包含1时则输出的最小值，比方是x(x>1)，则改为rownum &lt; x，等价limit x-1</p><p>如：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql>rownum <span style=color:#66d9ef>in</span>(<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>) <span style=color:#75715e>-- 返回1,2,3 
</span><span style=color:#75715e></span>rownum <span style=color:#66d9ef>in</span>(<span style=color:#ae81ff>0</span>,<span style=color:#ae81ff>1</span>,<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>5</span>,<span style=color:#ae81ff>6</span>,<span style=color:#ae81ff>7</span>) <span style=color:#75715e>-- 返回1,2,3 
</span><span style=color:#75715e></span>rownum <span style=color:#66d9ef>in</span>(<span style=color:#ae81ff>2</span>,<span style=color:#ae81ff>3</span>,<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>5</span>,<span style=color:#ae81ff>7</span>,<span style=color:#ae81ff>8</span>,<span style=color:#ae81ff>9</span>) <span style=color:#75715e>-- 返回空
</span></code></pre></div></li><li><p>[not] between &mldr; and ..</p><p>相当于<code>limit m,n</code> m也要求从小于1</p><p>between min and max</p><p>如果没有not，当between不合法时，即min>max时，返回空集；合法时，min>1时，返回空集，min&lt;=1时相当与limit max。</p><p>当有not，不合法时，返回全集；合法时，min&lt;=1，返回空集，min>1时，相当与limit min-1</p></li></ul></li></ol><h2 id=实现>实现</h2><ol><li><p>改写rownum的format函数</p><p>需要完成从原始sql中去除所有rownum。对于select子句中的rownum，按照附录一的方法，改写成自定义变量；对于where条件中的rownum，将其合并成为一个limit。</p><p>需要注意：</p><ul><li>输出列中可能包含多个rownum</li><li>rownum可能会涉及到复杂的表达式</li><li>rownum的优先级高于同级的order by</li></ul></li><li><p>对数据进行fillRownum的操作</p><p>这主要是为了处理分布式场景。也就是，从底下MySQL中获取到数据以后，对数据加上伪列的过程</p></li></ol><h2 id=需要注意的地方>需要注意的地方</h2><ol><li><p>不支持rownum伪列和limit混用</p></li><li><p>不支持rownum四则运算，如rownum=rownum+1, (rownum+1)*10&lt;100等，以及一些其他的复杂比较函数如like/not like等</p></li><li><p>复杂条件支持测试不完善，可能会有坑</p></li><li><p>不支持or条件包含rownum，如<code>select rownum,t.* from t where id > 7 or rownum &lt; 3</code></p><p>按照我们的处理方法，转换为limit后，sql就会变为<code>select t.* from t where id > 8 limit 2;</code> 结果明显是不对的，也就是说or条件中的rownum不能随便转换为limit。可以看附录二的例子。</p></li></ol><h2 id=附录一>附录一</h2><p>在单个mysql中模拟oracle rownum一个的方法：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>select</span> <span style=color:#f92672>@</span>rn:<span style=color:#f92672>=@</span>rn<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> <span style=color:#66d9ef>as</span> rownum,t.<span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> (Original <span style=color:#66d9ef>SQL</span>) t,(<span style=color:#66d9ef>select</span> <span style=color:#f92672>@</span>rn:<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) r;
</code></pre></div><p>利用MySQL里面的自定义变量，每次从原来SQL中取一条数据，让rn自增。</p><h2 id=附录二>附录二</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> t(id int <span style=color:#66d9ef>primary</span> <span style=color:#66d9ef>key</span>, name varchar(<span style=color:#ae81ff>20</span>));
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t(id,name) <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>1</span>,<span style=color:#e6db74>&#39;c_9&#39;</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t(id,name) <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>2</span>,<span style=color:#e6db74>&#39;c_8&#39;</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t(id,name) <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>3</span>,<span style=color:#e6db74>&#39;c_7&#39;</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t(id,name) <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>4</span>,<span style=color:#e6db74>&#39;c_6&#39;</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t(id,name) <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>5</span>,<span style=color:#e6db74>&#39;c_5&#39;</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t(id,name) <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>6</span>,<span style=color:#e6db74>&#39;c_4&#39;</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t(id,name) <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>7</span>,<span style=color:#e6db74>&#39;c_3&#39;</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t(id,name) <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>8</span>,<span style=color:#e6db74>&#39;c_2&#39;</span>);
<span style=color:#66d9ef>insert</span> <span style=color:#66d9ef>into</span> t(id,name) <span style=color:#66d9ef>values</span>(<span style=color:#ae81ff>9</span>,<span style=color:#e6db74>&#39;c_1&#39;</span>);

<span style=color:#66d9ef>select</span> rownum,t.<span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t <span style=color:#66d9ef>where</span> id  <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>7</span> <span style=color:#66d9ef>or</span> rownum <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>3</span>;
<span style=color:#75715e>-- 在oracle中的执行上面这条sql的结果如下
</span><span style=color:#75715e>-- id为1和2的行满足rownum的条件，id为8和9的行满足id&gt;7的条件
</span><span style=color:#75715e></span><span style=color:#f92672>+</span><span style=color:#75715e>--------+----+------+
</span><span style=color:#75715e></span><span style=color:#f92672>|</span> ROWNUM <span style=color:#f92672>|</span> ID <span style=color:#f92672>|</span> NAME <span style=color:#f92672>|</span>
<span style=color:#f92672>+</span><span style=color:#75715e>--------+----+------+
</span><span style=color:#75715e></span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>1</span><span style=color:#f92672>|</span>  <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span> c_9  <span style=color:#f92672>|</span>
<span style=color:#f92672>+</span><span style=color:#75715e>--------+----+------+
</span><span style=color:#75715e></span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>2</span><span style=color:#f92672>|</span>  <span style=color:#ae81ff>2</span> <span style=color:#f92672>|</span> c_8  <span style=color:#f92672>|</span>
<span style=color:#f92672>+</span><span style=color:#75715e>--------+----+------+
</span><span style=color:#75715e></span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>3</span><span style=color:#f92672>|</span>  <span style=color:#ae81ff>8</span> <span style=color:#f92672>|</span> c_2  <span style=color:#f92672>|</span>
<span style=color:#f92672>+</span><span style=color:#75715e>--------+----+------+
</span><span style=color:#75715e></span><span style=color:#f92672>|</span>       <span style=color:#ae81ff>4</span><span style=color:#f92672>|</span>  <span style=color:#ae81ff>9</span> <span style=color:#f92672>|</span> c_1  <span style=color:#f92672>|</span>
<span style=color:#f92672>+</span><span style=color:#75715e>--------+----+------+
</span><span style=color:#75715e></span>
<span style=color:#75715e>-- 如果改成limit，在MySQL上执行的效果大概是这样
</span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> <span style=color:#f92672>@</span>rn:<span style=color:#f92672>=@</span>rn<span style=color:#f92672>+</span><span style=color:#ae81ff>1</span> rownum,t.<span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> (<span style=color:#66d9ef>select</span> <span style=color:#f92672>*</span> <span style=color:#66d9ef>from</span> t <span style=color:#66d9ef>where</span> id <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>8</span> <span style=color:#66d9ef>limit</span> <span style=color:#ae81ff>2</span>) t,(<span style=color:#66d9ef>select</span> <span style=color:#f92672>@</span>rn:<span style=color:#f92672>=</span><span style=color:#ae81ff>0</span>) r;
<span style=color:#f92672>+</span><span style=color:#75715e>--------+----+------+
</span><span style=color:#75715e></span><span style=color:#f92672>|</span> rownum <span style=color:#f92672>|</span> id <span style=color:#f92672>|</span> name <span style=color:#f92672>|</span>
<span style=color:#f92672>+</span><span style=color:#75715e>--------+----+------+
</span><span style=color:#75715e></span><span style=color:#f92672>|</span>      <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span>  <span style=color:#ae81ff>9</span> <span style=color:#f92672>|</span> c_1  <span style=color:#f92672>|</span>
<span style=color:#f92672>+</span><span style=color:#75715e>--------+----+------+
</span></code></pre></div><br><center>·End·</center></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>longfei</span></p><p class=copyright-item><span>Link:</span>
<a href=https://longfeis.me/2021/realize-rownum/>https://longfeis.me/2021/realize-rownum/</span></p><p class="copyright-item lincese">本文采用<a rel=license href=https://creativecommons.org/licenses/by-nc-nd/3.0/cn/deed.zh style=color:#add8e6 target=_blank>《署名-非商业性使用-禁止演绎 3.0 中国大陆》</a> 协议进行许可</p></div><div class=post-tags><section><i class="iconfont icon-tag"></i>Tag(s):
<span class=tag><a href=https://longfeis.me/tags/databasee/>#Databasee</a></span></section><section><a href=javascript:window.history.back();>back</a></span> ·
<span><a href=https://longfeis.me/>home</a></span></section></div><div class=post-nav><a href=https://longfeis.me/2021/my-2020/ class=prev rel=prev title=我的2020年><i class="iconfont icon-left"></i>&nbsp;我的2020年</a>
<a href=https://longfeis.me/2021/disney/ class=next rel=next title=上海·迪斯尼乐园>上海·迪斯尼乐园&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2020 - 2021</span>
<span class=with-love><i class="iconfont icon-love"></i></span>
<span class=author itemprop=copyrightHolder><a href=https://longfeis.me/>longfei</a> |</span>
<span>Powered by <a href=https://gohugo.io/ target=_blank rel="external nofollow">Hugo</a> & <a href=https://github.com/Mogeko/Mogege target=_blank rel="external nofollow">Mogege</a></span></div></footer><script defer src=/js/vendor_main.min.js></script><script src=https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js integrity="sha256-j+yj56cdEY2CwkVtGyz18fNybFGpMGJ8JxG3GSyO2+I=" crossorigin=anonymous></script><script>pangu.spacingPage()</script></div></body></html>